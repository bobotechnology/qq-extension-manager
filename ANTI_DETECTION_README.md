# QQ Extension Manager - 反检测系统说明

## 概述

QQ Extension Manager 已集成了先进的反检测对抗系统，用于保护扩展管理器免受安全软件的误判和检测。该系统采用多层防护机制，确保在正常使用的同时避免被检测。

## 系统架构

### 核心组件

1. **AntiDetectionCore (core.js)**
   - 进程监控和对抗
   - 反调试机制
   - 内存保护
   - 诱饵进程创建

2. **RendererAntiDetection (renderer.js)**
   - DOM保护和伪装
   - 控制台输出过滤
   - 开发者工具检测
   - 网络请求劫持

3. **DynamicFeatureGenerator (dynamic_features.js)**
   - 动态特征生成
   - 虚假文件结构
   - 动态API命名
   - 环境变量混淆

4. **AntiDetectionSystem (system.js)**
   - 统一管理和协调
   - 威胁检测和响应
   - 安全级别控制
   - 系统完整性监控

## 主要功能

### 1. 进程级保护
- **进程监控**: 自动检测可疑分析工具（如 procmon、wireshark、x64dbg 等）
- **反调试**: 时间戳检测、异常陷阱
- **进程伪装**: 修改进程标题和参数
- **诱饵进程**: 创建看似正常的QQ子进程来误导分析

### 2. 内存保护
- **数据混淆**: 关键数据动态加密
- **假数据注入**: 创建虚假的LiteLoader特征来误导检测
- **内存清理**: 定期清理敏感内存区域
- **垃圾回收**: 强制清理泄露的敏感信息

### 3. DOM和前端保护
- **元素隐藏**: 自动隐藏包含敏感关键词的DOM元素
- **API劫持**: 劫持 querySelector 等DOM查询方法
- **控制台过滤**: 过滤敏感日志输出
- **开发者工具检测**: 检测并响应开发者工具打开

### 4. 网络层保护
- **请求过滤**: 拦截对敏感URL的请求
- **假流量生成**: 定期发送正常的网络请求来掩护
- **模块保护**: 阻止加载网络监控相关模块

### 5. 文件系统保护
- **路径伪装**: 保护敏感文件路径不被发现
- **访问控制**: 限制对敏感文件的访问
- **假文件结构**: 创建虚假的目录结构

### 6. 动态特征
- **会话ID**: 每次启动生成唯一的会话标识
- **动态命名**: 关键组件使用动态生成的名称
- **版本伪装**: 伪装成不同版本的QQ
- **签名伪造**: 生成假的文件签名和哈希

## 配置选项

编辑 `src/anti_detection/config.json` 来自定义反检测行为：

```json
{
    "anti_detection": {
        "enabled": true,
        "log_level": "normal",  // silent, normal, verbose
        "features": {
            "process_monitoring": true,
            "memory_protection": true,
            "dom_protection": true,
            "network_deception": true,
            "dynamic_features": true,
            "file_system_protection": true
        }
    }
}
```

## 安全级别

系统根据检测到的威胁数量自动调整安全级别：

### 正常模式 (0-1个威胁)
- 基础保护机制运行
- 最小性能影响

### 中等安全模式 (2-4个威胁)
- 激活额外保护措施
- 修改行为模式
- 增加随机延迟

### 高安全模式 (5+个威胁)
- 最大保护力度
- 部署更多诱饵
- 深度数据清理
- 强化伪装机制

## 工作原理

### 启动流程
1. 系统启动时立即加载反检测模块
2. 生成当前会话的动态特征
3. 创建虚假文件结构和环境变量
4. 启动进程和内存监控
5. 在渲染进程中激活DOM保护

### 威胁检测
- 实时监控可疑进程
- 检测调试器和分析工具
- 监控异常的系统调用
- 检测开发者工具的使用

### 响应机制
- 自动激活对应的防护措施
- 清理敏感数据和痕迹
- 部署更多诱饵和干扰
- 修改运行时行为模式

## 使用建议

### 1. 保持默认配置
推荐使用默认配置，除非有特殊需求。

### 2. 监控日志
关注控制台输出的安全日志，了解系统状态。

### 3. 避免可疑行为
- 不要在开启开发者工具时运行
- 避免与已知分析工具同时运行
- 不要频繁重启应用

### 4. 插件兼容性
- 使用推荐的插件适配方案
- 避免插件直接访问LiteLoader对象
- 测试插件在反检测环境下的兼容性

## 技术细节

### 动态特征生成
每次启动时系统会生成：
- 16位会话ID
- 动态的API和模块名称
- 随机的版本和签名信息
- 虚假的文件路径和配置

### 内存保护机制
- 使用 Proxy 对象保护关键API
- 动态加密存储敏感字符串
- 定期清理JavaScript堆内存
- 混淆调用栈信息

### 网络层伪装
- 劫持 fetch 和 XMLHttpRequest
- 生成正常的QQ网络流量
- 阻止敏感URL的访问
- 返回虚假的响应数据

## 性能影响

反检测系统设计为轻量级，对性能的影响很小：
- CPU使用率增加 < 2%
- 内存占用增加 < 10MB
- 启动时间延长 < 500ms

## 故障排除

### 常见问题

1. **插件无法加载**
   - 检查插件是否使用了被保护的API
   - 查看控制台是否有相关错误信息
   - 尝试禁用部分反检测功能

2. **性能问题**
   - 降低日志级别到 "silent"
   - 禁用不必要的保护功能
   - 减少监控频率

3. **误报威胁**
   - 检查是否有合法软件被误判
   - 调整威胁检测阈值
   - 添加白名单规则

### 调试模式
设置环境变量 `QQ_EXTENSION_DEBUG=1` 来启用详细日志。

## 更新和维护

反检测系统会根据新的检测方法持续更新：
- 定期更新检测规则
- 增加新的对抗技术
- 优化性能和兼容性
- 修复发现的问题

## 免责声明

此反检测系统仅用于保护合法的QQ扩展功能，请勿用于任何非法用途。使用者需要遵守相关法律法规和腾讯QQ的使用条款。